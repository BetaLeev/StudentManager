<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>登录修改密码</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../aui-20170109-v2.1/css/aui.css" />
    <link rel="stylesheet" href="../../css/common.css">
    <style>
        body {
            text-align: center;
        }

        header {
            padding-top: 25px !important;
            border-bottom: 1px solid #f1f1f1;
            background-color: #f0f0f0;
        }

        header * {
            color: #4b4b4b !important;
        }

        .aui-bar,
        .aui-bar span {
            color: #4b4b4b !important;
        }

        .row {
            box-sizing: border-box;
            width: auto;
            height: 70px;
            margin-left: 45px;
            margin-right: 45px;
            padding-top: 30px;
            border-bottom: 1px solid #f1f1f1;
        }

        .input {
            width: 100%;
            height: 20px;
            line-height: 20px;
            border: none;
            outline: none;
            font-size: 16px;
            /*text-align: center;*/
            margin-top: 40px;
        }

        .coll {
            width: auto;
            height: 70px;

        }

        .btnyzm {
            width: 25%;
            height: 30px;
            margin-left: 0px;
            margin-right: 5px;
            background-color: #fff;
            color: #4b4b4b;
            font-size: 13px;
            line-height: 30px;
            text-align: center;
            border-radius: 15px;
            float: right;
            margin-top: -30px;
            margin-right:35px;
            border:1px solid #9fa0a0;
        }

        .iszcxy {
            width: 100%;
            height: 70px;
            float: center;
            text-align: center;
        }

        .isxz {
            font-size: 20px;
            float: left;
            margin-left: 30%;
            margin-top: 14px;
            color: #707070;
            margin-right: 5px;
        }

        .zcxy {
            font-size: 14px;
            width: auto;
            line-height: 57px;
            text-align: left;
            color: #707070;
            margin-left: 12px;
        }

        .btn {
            width: 40%;
            height: 40px;
            margin-left: 30%;
            margin-right: 40%;
            margin-top: 250px;
            background-color: #FED765;
            color: #4b4b4b;
            font-size: 19px;
            line-height: 40px;
            text-align: center;
            border-radius: 8px;
        }

        .highlight {
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <header class="aui-bar aui-bar-nav aui-bar-light">
        <div class="aui-pull-left aui-btn">
            <span class="aui-iconfont aui-icon-left" onclick="closeCurrentWin()"></span>
        </div>
        <div class="aui-title">修改密码</div>
        <div class="aui-pull-right aui-btn">
            <!-- <span>注册</span> -->
        </div>
    </header>
    <div class="row">
        <input id="phonenumber" class="input" type="text" placeholder="请输入您的手机号">
    </div>
    <div class="coll">
        <div class="row">
            <input id="yanzhengma" class="input" type="text" placeholder="请输入您的验证码">
        </div>
        <div class="btnyzm">验证码</div>
    </div>
    <div class="row">
        <input id="password" class="input" type="password" placeholder="请输入您的密码">
    </div>
    <div class="row">
        <input id="password" class="input" type="password" placeholder="请确认您的密码">
    </div>
    <!-- <div class="iszcxy">
        <div class="isxz">o</div>
        <div class="zcxy">用户注册协议、服务条款</div>
    </div> -->
    <div class="btn" onclick="fnRegister()">完成</div>
</body>
<script src="../../script/common.js" charset="utf-8"></script>

<script type="text/javascript" src="../../script/api.js"></script>
<!-- <script type="text/javascript" src="../script/SHA1.js"></script> -->
<!-- <script type="text/javascript" src="../script/APICloud-rest.js"></script> -->
<script type="text/javascript">
    apiready = function() {
        setTimeout(function() {
            api.execScript({
                name: api.pageParam.winname,
                frameName: api.pageParam.framename,
                // script: 'close_now_win()'
            });
        }, 500);
    };
    // 设置成手机号登录的形式，11位，密码设置成6-20位，如果不成功请重新输入
    function fncheckinput(username, phonenumber, pwd) {
        if (pwd.length < 6 || pwd.length > 20 || username.length == 0) {
            return false;
        } else if (phonenumber.length != 11 || !(/^1[3456789]\d{9}$/).test(phonenumber)) {
            // alert("手机号输入格式不正确");
            return false;
        } else {
            return true;
        }
    }
    // 。
    function fnRegister() {
        var vusername = $api.val($api.byId("username")).replace(/^\s*|\s*$/g, '');
        var vphonenumber = $api.val($api.byId("phonenumber")).replace(/^\s*|\s*$/g, '');
        var vpassword = $api.val($api.byId("password")).replace(/^\s*|\s*$/g, '');
        var flag_input = fncheckinput(vusername, vphonenumber, vpassword);
        if (flag_input) {
            var now = Date.now();
            var appKey = SHA1("A6006620792786" + "UZ" + "B4BE1D4A-18F6-42D1-48CF-DF6C6EA9983E" + "UZ" + now) + "." + now
            api.ajax({
                    url: 'https://www.apicloud.com/mcm/api/user',
                    method: 'post',
                    headers: {
                        "X-APICloud-APPId": "A6006620792786",
                        "X-APICloud-APPKey": appKey
                    },
                    data: {
                        values: {
                            username: vphonenumber,
                            nickname: vusername,
                            password: vpassword
                        }
                    }
                },
                function(ret, err) {
                    if (ret && ret.id) {
                        api.toast({
                            msg: '注册成功！自动登录',
                            duration: 2000,
                            location: 'middle'
                        });
                        api.setPrefs({
                            key: 'userloginstatu',
                            value: true
                        });
                        api.setPrefs({
                            key: 'user_name',
                            value: vusername
                        });
                        api.setPrefs({
                            key: 'user_phone',
                            value: vphonenumber
                        });
                        if (!api.getPrefs({
                                sync: true,
                                key: 'bind_flag'
                            })) {
                            var push = api.require('push');
                            push.bind({
                                userName: vphonenumber,
                                userId: vphonenumber
                            }, function(ret, err) {
                                api.setPrefs({
                                    key: 'bind_flag',
                                    value: 'true'
                                });
                            });
                        }
                        if (api.pageParam.filename) {
                            api.closeWin({
                                name: api.winName
                            });
                            if (api.pageParam.title) {
                                api.openWin({
                                    name: 'detailPage',
                                    url: api.pageParam.page_url,
                                    pageParam: {
                                        name: api.pageParam.name,
                                        title: api.pageParam.title,
                                        filename: api.pageParam.filename
                                    }
                                });
                            } else {
                                api.openWin({
                                    name: 'detailPage',
                                    url: api.pageParam.page_url,
                                    pageParam: {
                                        name: api.pageParam.name,
                                        filename: api.pageParam.filename
                                    }
                                });
                            }
                        } else {
                            api.execScript({
                                name: 'root',
                                frameName: 'frame_my',
                                script: "change_phone_login('" + vphonenumber + "')"
                            });

                            api.closeWin({
                                name: api.winName
                            });
                        }
                    } else {
                        alert("注册失败！");
                    }

                }
            );
        } else {
            alert("注册信息格式不正确，请确认格式正确后再注册");
        }

    }
</script>

</html>
