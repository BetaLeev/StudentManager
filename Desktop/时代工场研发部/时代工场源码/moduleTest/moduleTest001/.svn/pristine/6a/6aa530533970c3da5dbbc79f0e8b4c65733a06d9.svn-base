<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>注册Frame</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>
    .row {
        box-sizing: border-box;
        width: auto;
        height: 70px;
        margin-left: 32px;
        margin-right: 32px;
        padding-top: 40px;
        border-bottom: 1px solid #888;
    }

    .input {
        width: 100%;
        height: 20px;
        line-height: 20px;
        border: none;
        outline: none;
        font-size: 16px;
    }

    .btn {
        width: auto;
        height: 50px;
        margin-left: 32px;
        margin-right: 32px;
        margin-top: 32px;
        background-color: #125E88;
        color: #fff;
        font-size: 24px;
        line-height: 50px;
        text-align: center;
        border-radius: 8px;
    }

    .highlight {
        opacity: 0.7;
    }
    </style>
</head>

<body>
    <div class="row">
        <input id="username" class="input" type="text" placeholder="请输入您的姓名">
    </div>
    <div class="row">
        <input id="phonenumber" class="input" type="text" placeholder="请输入您的手机号">
    </div>
    <div class="row">
        <input id="password" class="input" type="password" placeholder="请输入您的密码">
    </div>
    <div class="btn" onclick="fnRegister()">注册</div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript" src="../script/APICloud-rest.js"></script>
<script type="text/javascript">
apiready = function() {
    setTimeout(function() {
        api.execScript({
            name: api.pageParam.winname,
            frameName: api.pageParam.framename,
            script: 'close_now_win()'
        });
    }, 500);
};
// 设置成手机号登录的形式，11位，密码设置成6-20位，如果不成功请重新输入
    function fncheckinput(username,phonenumber,pwd){
        if(pwd.length<6||pwd.length>20||username.length==0){
            return false;
        }else if(phonenumber.length!=11||!(/^1[3456789]\d{9}$/).test(phonenumber)){
            // alert("手机号输入格式不正确");
            return false;
        }else{
            return true;
        }
    }
// 。
    function fnRegister(){
        var vusername = $api.val($api.byId("username")).replace(/^\s*|\s*$/g,'');
        var vphonenumber = $api.val($api.byId("phonenumber")).replace(/^\s*|\s*$/g,'');
        var vpassword = $api.val($api.byId("password")).replace(/^\s*|\s*$/g,'');
        var flag_input = fncheckinput(vusername,vphonenumber,vpassword);
        if(flag_input){
            var now = Date.now();
            var appKey = SHA1("A6006620792786"+"UZ"+"B4BE1D4A-18F6-42D1-48CF-DF6C6EA9983E"+"UZ"+now)+"."+now
            api.ajax({
                url: 'https://www.apicloud.com/mcm/api/user',
                method: 'post',
                headers: {
                "X-APICloud-APPId": "A6006620792786",
                "X-APICloud-APPKey": appKey
                },
                data: {
                    values:{
                        username:vphonenumber,
                        nickname:vusername,
                        password:vpassword
                    }
                }
            },
            function(ret, err){
                if (ret && ret.id) {
                    api.toast({
                    msg: '注册成功！自动登录',
                    duration: 2000,
                    location: 'middle'
                });
                api.setPrefs({
                    key: 'userloginstatu',
                    value: true
                });
                api.setPrefs({
                    key: 'user_name',
                    value: vusername
                });
                api.setPrefs({
                        key: 'user_phone',
                        value: vphonenumber
                });
                if(!api.getPrefs({sync:true,key:'bind_flag'})){
                        var push = api.require('push');
                        push.bind({
                            userName: vphonenumber,
                            userId: vphonenumber
                        },function(ret,err){
                            api.setPrefs({
                                key: 'bind_flag',
                                value: 'true'
                            });
                        });
                    }
                if(api.pageParam.filename){
                    api.closeWin({
                        name: api.winName
                    });
                    if(api.pageParam.title){
                        api.openWin({
                            name: 'detailPage',
                            url: api.pageParam.page_url,
                            pageParam: {
                                name: api.pageParam.name,
                                title:api.pageParam.title,
                                filename:api.pageParam.filename
                            }
                        });
                    }else{
                        api.openWin({
                            name: 'detailPage',
                            url: api.pageParam.page_url,
                            pageParam: {
                                name: api.pageParam.name,
                                filename:api.pageParam.filename
                            }
                        });
                    }
            }else{
                api.execScript({
                            name: 'root',
                            frameName: 'frame_my',
                            script: "change_phone_login('"+vphonenumber+"')"
                        });
                       
                        api.closeWin({
                        name: api.winName
                    });
            } 
                } else {
                    alert("注册失败！");
                }

            }
            );
        }else{
            alert("注册信息格式不正确，请确认格式正确后再注册");
        }
        
    }
</script>
</html>
